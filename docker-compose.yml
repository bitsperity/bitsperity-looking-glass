services:
  satbase-api:
    build: .
    network_mode: host
    env_file:
      - .env
    volumes:
      - ./data:/app/data
      - ./libs/satbase_core/config:/app/libs/satbase_core/config:ro
      - ./apps:/app/apps:ro
      - ./libs:/app/libs:ro
    command: ["uvicorn", "apps.satbase_api.main:app", "--host", "0.0.0.0", "--port", "8080", "--reload"]

  satbase-ingest:
    build: .
    network_mode: host
    env_file:
      - .env
    volumes:
      - ./data:/app/data
      - ./libs/satbase_core/config:/app/libs/satbase_core/config:ro
    command: ["python", "-m", "libs.satbase_core.ingest.run_daily"]

  looking-glass:
    build: ./apps/looking_glass
    network_mode: host
    environment:
      - VITE_API_BASE=http://127.0.0.1:8080
      - VITE_TESSERACT_BASE=http://127.0.0.1:8081
      - VITE_ARIADNE_BASE=http://127.0.0.1:8082
    working_dir: /app
    volumes:
      - ./apps/looking_glass/src:/app/src:ro

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./data/qdrant:/qdrant/storage
    environment:
      - QDRANT__LOG_LEVEL=INFO
    restart: unless-stopped

  satbase-scheduler:
    build: ./apps/satbase_scheduler
    network_mode: host
    environment:
      - SATBASE_API_URL=http://localhost:8080
    depends_on:
      - satbase-api
    restart: unless-stopped

  tesseract-api:
    build: .
    network_mode: host
    env_file:
      - .env
    environment:
      - TESSERACT_DEVICE=cuda  # GPU enabled
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - OMP_NUM_THREADS=2
      - MKL_NUM_THREADS=2
      - TOKENIZERS_PARALLELISM=false
    volumes:
      - ./data:/app/data
      - ./libs:/app/libs:ro
      - ./apps:/app/apps:ro
    command: ["uvicorn", "apps.tesseract_api.main:app", "--host", "0.0.0.0", "--port", "8081"]
    depends_on:
      - qdrant
      - satbase-api
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: 12G
          cpus: '6'

  neo4j:
    image: neo4j:5.15-community
    ports:
      - "7474:7474"  # HTTP Browser
      - "7687:7687"  # Bolt protocol
    environment:
      - NEO4J_AUTH=neo4j/ariadne2025
      - NEO4J_PLUGINS=["graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=gds.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
    volumes:
      - ./data/neo4j:/data
      - ./data/neo4j-logs:/logs
    restart: unless-stopped

  ariadne-api:
    build: .
    network_mode: host
    env_file:
      - .env
    environment:
      - NEO4J_URI=bolt://localhost:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=ariadne2025
      - SATBASE_URL=http://localhost:8080
      - TESSERACT_URL=http://localhost:8081
    volumes:
      - ./data:/app/data
      - ./libs:/app/libs:ro
      - ./apps:/app/apps:ro
    command: ["uvicorn", "apps.ariadne_api.main:app", "--host", "0.0.0.0", "--port", "8082", "--reload"]
    depends_on:
      - neo4j
      - satbase-api
    restart: unless-stopped

  manifold-api:
    build: .
    network_mode: host
    env_file:
      - .env
    environment:
      - QDRANT_URL=http://localhost:6333
      - MANIFOLD_QDRANT_COLLECTION=manifold_thoughts
      - MANIFOLD_EMBED_MODEL=mixedbread-ai/mxbai-embed-large-v1
      - MANIFOLD_EMBED_DEVICE=cuda  # cuda, cpu, or empty for auto-detect
    volumes:
      - ./apps:/app/apps
      - ./libs:/app/libs
      - ./data:/app/data
    command: ["uvicorn", "apps.manifold_api.main:app", "--host", "0.0.0.0", "--port", "8083", "--reload"]
    depends_on:
      - qdrant
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

